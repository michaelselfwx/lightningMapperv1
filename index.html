<!DOCTYPE html>
<html lang="en">
<head>
    <title>SPC Outlook Mapper</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="" />

    <!-- CSS for the page and the map -->
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%; 
            width: 100%;
        }
        #dateDiv {
            position: absolute;
            top: 1%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 1);
            border: 1px solid black;
            border-radius: 5px;
            z-index: 1000;
            width: 33%; /* fixed width */
            height: 5%; /* fixed height */
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(0.5px + 1vw); /* adjust as needed */
        }
        /* For mobile devices */
        @media screen and (max-width: 768px) {
            #dateDiv {
                width: 55%; /* adjust as needed */
                height: 7%; /* adjust as needed */
                font-size: calc(1px + 3vw); /* adjust as needed */
            }
            #toggle-left, #toggle-right {
                font-size: calc(1px + 3vw); /* adjust as needed */
            }
        }
        /* For iPads */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            #dateDiv {
                width: 45%; /* adjust as needed */
                height: 5%; /* adjust as needed */
                font-size: calc(1px + 2vw); /* adjust as needed */
            }
        }
        .small-legend {
            transform: scale(0.8); /* Adjust as needed */
            position: absolute;
            bottom: 0;
            left: 0;
            padding: 10px;
        }
        .esri-layer-list {
            margin-top: 20px; /* Adjust as needed */
        }
    </style>

    <!-- ArcGIS API's CSS file and JS library -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.25/"></script>

</head>
<body>

    <!-- The div to display the map -->
    <div id="viewDiv"></div>
    <div id="dateDiv"></div>

    <!-- JavaScript for the map -->
    <script>
        require([
            "esri/config",
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/GeoJSONLayer",
            "esri/widgets/Legend",
            "esri/widgets/LayerList",
            "esri/widgets/Editor",
            "esri/Graphic",
        ], function (esriConfig, Map, MapView, GeoJSONLayer, Legend, LayerList, Editor, Graphic) {
            // Set the API key
            esriConfig.apiKey = "AAPKfb3b968ef66d4c848e795b3dd01897e8uTic-7qcXbjlpUVMGReQlWKWAjnWq5pH5r7mLxpcFbX1tfR5Y4bLBPhLOwFOm7NL";

            // Make sure the page refreshes when the user is inactive
            var timeout;
            var delay = 5 * 60 * 1000; // 5 minutes
            function resetTimeout() {
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    location.reload();
                }, delay);
            }
            window.onload = resetTimeout;
            window.onmousemove = resetTimeout;
            window.onmousedown = resetTimeout; 
            window.ontouchstart = resetTimeout;
            window.onclick = resetTimeout;     
            window.onscroll = resetTimeout;    
            window.onkeypress = resetTimeout;

            // Create the map
            var map = new Map({
                basemap: "topo-vector",          
            });

            // Create the view
            var view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-98.5795, 37.8283],
                ui: {
                    components: ["attribution"]
                }
            });
            view.scale = 18650000; // Sets a 1:24,0000 scale on the view

            // Add LayerList to the view
            var layerList = new LayerList({
                view: view
            });
            view.ui.add(layerList, "top-right");

            // Add Editor widget to the view
            var editor = new Editor({
                view: view
            });
            view.ui.add(editor, "bottom-right");



            // Define a function to get the URL for a given hour and date
            function getUrl(hour, date) {
                var minutes = Math.round((hour % 1) * 60);
                hour = ('0' + Math.floor(hour)).slice(-2);
                minutes = ('0' + minutes).slice(-2);
                var formattedDateTime = date.year + date.month + date.day + '_' + hour + minutes;
                var url = "https://ham-shack-pi.tail8c79a.ts.net/proxy?url=https://www.spc.noaa.gov/products/outlook/archive/2024/day1otlk_" + formattedDateTime + "_cat.lyr.geojson";
                return { url: url, formattedDateTime: formattedDateTime}
            }

            // Define a function to get the previous available hour
            function getPreviousHour(hour, date) {
                var index = availableHours.indexOf(hour);
                if (index > 0) {
                    return { hour: availableHours[index - 1], date: date };
                } else {
                    date.setDate(date.getDate() - 1);
                    var year = date.getUTCFullYear();
                    var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
                    var day = ('0' + date.getUTCDate()).slice(-2);
                    return { hour: availableHours[availableHours.length - 1], date: { year: year, month: month, day: day } };
                }
            }

            // Define a function to create a GeoJSON layer
            function createGeoJSONLayer(url, data) {
                var renderer = {
                    type: "unique-value",
                    field: "LABEL2",
                    uniqueValueInfos: [
                        { 
                            value: "General Thunderstorms Risk", 
                            symbol: {
                                type: "simple-fill", 
                                color: [0, 128, 0, 0.25], 
                                outline: { width: 0.5, color: "black" }
                            }
                        },
                        { 
                            value: "Marginal Risk", 
                            symbol: {
                                type: "simple-fill", 
                                color: [255, 255, 0, 0.30], 
                                outline: { width: 0.5, color: "black" }
                            }
                        },
                        { 
                            value: "Slight Risk", 
                            symbol: {
                                type: "simple-fill", 
                                color: [255, 165, 0, 0.35], 
                                outline: { width: 0.5, color: "black" }
                            }
                        },
                        { 
                            value: "Enhanced Risk", 
                            symbol: {
                                type: "simple-fill", 
                                color: [255, 75, 0, 0.40], 
                                outline: { width: 0.5, color: "black" }
                            }
                        },
                        { 
                            value: "Moderate Risk", 
                            symbol: {
                                type: "simple-fill", 
                                color: [255, 0, 0, 0.45], 
                                outline: { width: 0.5, color: "black" }
                            }
                        },
                        { 
                            value: "High Risk", 
                            symbol: {
                                type: "simple-fill", 
                                color: [255, 0, 255, 0.5], 
                                outline: { width: 0.5, color: "black" }
                            }
                        }
                    ]
                };

                var geojsonLayer = new GeoJSONLayer({
                    url: url.url,
                    title: "Day 1 Convective Outlook",
                    renderer: renderer,
                    popupTemplate: {
                        title: "Categorical Outlook",
                        content: "{LABEL2}"
                    }
                });

                // Add the GeoJSON layer to the map
                map.add(geojsonLayer);

                // Update the date div
                if (data) {
                    var validTime = data.features[0].properties.VALID;
                    var expireTime = data.features[0].properties.EXPIRE;

                    var validFormatted = validTime.substring(4,6) + "/" + validTime.substring(6,8) + "/" + validTime.substring(0,4) + " @ " + validTime.substring(8,10) + validTime.substring(10,12) + " UTC";
                    var expireFormatted = expireTime.substring(4,6) + "/" + expireTime.substring(6,8) + "/" + expireTime.substring(0,4) + " @ " + expireTime.substring(8,10) + expireTime.substring(10,12) + " UTC";

                    var dateDiv = document.getElementById('dateDiv');
                    if (!dateDiv.textContent) {
                        dateDiv.textContent = 'Outlook Valid: ' + validFormatted + ' - ' + expireFormatted;
                    }
                }
            };

            // Get the current date and time (UTC, not local)
            var date = new Date();
            var year = date.getUTCFullYear();
            var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
            var day = ('0' + date.getUTCDate()).slice(-2);
            var hour = date.getUTCHours().toString().padStart(2, '0');

            // Define the available hours for the day 1 convective outlook
            var availableHours = [1, 12, 13, 16.5, 20];

            // Determine the closest available hour to the current hour
            var closestHour, result;
            if (hour < availableHours[0]) {
                // If the current hour is before the first available hour, use the last available hour from the previous day
                closestHour = availableHours[availableHours.length - 1];
                date.setDate(date.getDate() - 1);
                year = date.getUTCFullYear();
                month = ('0' + (date.getUTCMonth() + 1)).toString().slice(-2);
                day = ('0' + (date.getUTCDate()).toString().slice(-2));
                result = { closestHour: closestHour, date: { year: year, month: month, day: day } };
            } else {
                // Otherwise, use the available hour that is closest to the current hour
                closestHour = availableHours.reduce(function(prev, curr) {
                    return (curr <= hour && Math.abs(curr - hour) < Math.abs(prev - hour) ? curr : prev);
                });
                result = { closestHour: closestHour, date: date };
            }

            // Get the data for the closest available hour
            var urlData = getUrl(closestHour, { year: year, month: month, day: day });
            console.log(urlData.url);

            // Fetch the data for the closest available hour
            fetch(urlData.url)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(function(data) {
                    // Data for the new hour is available, proceed as normal
                    createGeoJSONLayer(urlData, data);
                })
                .catch(function(error) {
                    // Data for the new hour is not available, use the previous hour
                    var previous = getPreviousHour(closestHour, date);
                    url = getUrl(previous.hour, previous.date);
                    fetch(url.url)
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            createGeoJSONLayer(url, data);
                        })
                        .catch(function(error) {
                            console.error('Error fetching data:', error);
                        });
                });

            // URL of the GeoJSON data
            var stormreportsJson = new GeoJSONLayer({
                url: "https://mesonet.agron.iastate.edu/data/gis/shape/4326/us/lsr_24hour.geojson",
                title: "Storm Reports",
                renderer: {
                    type: "unique-value",
                    field: "TYPETEXT",
                    uniqueValueInfos: [
                        {
                            value: "HAIL",
                            symbol: {
                                type: "simple-marker",
                                style: "circle",
                                color: "grey",
                                size: "7.5px"
                            }
                        },
                        {
                            value: "SNOW",
                            symbol: {
                                type: "simple-marker",
                                style: "circle",
                                color: "white",
                                outline: {
                                    color: "grey",
                                    width: 1
                                },
                                size: "5px"
                            }
                        },
                        {
                            value: "NON-TSTM WND GST",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: "green",
                                size: "7.5px"
                            }
                        },
                        {
                            value: "FLOOD",
                            symbol: {
                                type: "simple-marker",
                                color: "blue",
                                style: "diamond",
                                outline: {
                                    color: "black",
                                    width: 1
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "TSTM WND DMG",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: "green",
                                outline: {
                                    color: "black",
                                    width: 1
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "TSTM WND GST",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: "green",
                                outline: {
                                    color: "grey",
                                    width: 1
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "HIGH SUST WINDS",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: "pink",
                                outline: {
                                    color: "black",
                                    width: 1
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "RAIN",
                            symbol: {
                                type: "simple-marker",
                                style: "circle",
                                color: "blue",
                                outline: {
                                    color: "blue",
                                    width: 1
                                },
                                size: "5px"
                            }
                        },
                        {
                            value: "WILDFIRE",
                            symbol: {
                                type: "simple-marker",
                                style: "diamond",
                                color: "orange",
                                size: "7.5px"
                            }
                        },
                        {
                            value: "OTHER",
                            symbol: {
                                type: "simple-marker",
                                style: "x",
                                color: "red",
                                size: "7.5px"
                            }
                        }
                    ]
                },
                popupTemplate: {
                    title: "{TYPETEXT}",
                    content: function(feature) {
                        // Extract the hour and minute from the VALID string
                        var valid = feature.graphic.attributes.properties.VALID;
                        var hour = valid.substring(8, 10);
                        var minute = valid.substring(10, 12);

                        // Format the time
                        var time = hour + ":" + minute + " UTC";

                        // Create the content for the popup
                        var content = "Time: " + time + "<br>" +
                                    "Source: " + feature.graphic.attributes.properties.SOURCE + "<br>" +
                                    "Remarks: " + feature.graphic.attributes.properties.REMARK;

                        return content;
                    }
                }
            });

            map.add(stormreportsJson);
        }
    );
    </script>

</body>

</html>
