<!DOCTYPE html>
<html lang="en">
<head>
  <title>Lightning Mapper</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />

  <!-- calls for the arcgis api's CSS file and JS library. -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.25/"></script>

  <!-- Adding the modules, API key, and map constant needed for a full screen map app -->
  <script>

    require([
        "esri/config",
        "esri/Map",
        "esri/views/MapView",
        "esri/request",

        // adding in the modules for the graphic and graphic layer
        "esri/Graphic",
        "esri/layers/GraphicsLayer",

        //adding in the module for the feature layers
        "esri/layers/FeatureLayer",

        "esri/widgets/Editor",

        "esri/symbols/SimpleMarkerSymbol",

        "esri/symbols/SimpleFillSymbol",

        "esri/geometry/Point",

        "esri/widgets/Legend",

        "esri/widgets/Search"

    ], function (esriConfig, Map, MapView, Graphic, GraphicsLayer, FeatureLayer, Editor, SimpleMarkerSymbol, SimpleFillSymbol, Point, Legend, Search, esriRequest) {

        esriConfig.apiKey = "AAPKfb3b968ef66d4c848e795b3dd01897e8uTic-7qcXbjlpUVMGReQlWKWAjnWq5pH5r7mLxpcFbX1tfR5Y4bLBPhLOwFOm7NL";
        // esriConfig.apiKey = "";
                // Create the map with the GraphicsLayer
        var map = new Map({
            basemap: "topo-vector",
        });

        var view = new MapView({
        container: "viewDiv", // Reference to the scene div created in step 5
        map: map, // Reference to the map object created before the scene
        zoom: 7, // Sets the zoom level based on level of detail (LOD), this is what I think looks the best
        center: [-81.5158, 27.6648] // Sets the center point of view in lon/lat
        });

        // Create a new GraphicsLayer and add the graphic to it
        var graphicsLayer = new GraphicsLayer();
        // Log to check if graphicsLayer is properly created
        console.log("graphicsLayers:", graphicsLayer);

        try {
            map.add(graphicsLayer);
        }   catch (error) {
            console.error('Error adding graphics layer:', error);   
        }

        var bounds = {
            xmax: -79,
            xmin: -85,
            ymax: 31,
            ymin: 25
        };

        function addLightningStrikes(data) {
            // Create a new Graphic and add it to the GraphicsLayer
            data.forEach(function(strike) {
                var lon = strike.lon;
                var lat = strike.lat;
                
                if (lon >= bounds.xmin && lon <= bounds.xmax && lat >=bounds.ymin && lat <= bounds.ymax) {
                    var pointGraphic = new Graphic({
                        geometry: {
                            type: "point",
                            longitude: lon,
                            latitude: lat
                        },
                        symbol: {
                            type: "simple-marker",
                            color: "red",
                            size: "5px"
                        }
                    });
                    graphicsLayer.add(pointGraphic);
                }
            });
        }
        
        // Fetch the lightning data from the AWS server
        var url = "https://s3.amazonaws.com/noaa-goes16/GLM-L2-LCFA/2024/088/20/OR_GLM-L2-LCFA_G16_s20240882000000_e20240882000200_c20240882000220.nc";
        
        esriRequest(url, {
            responseType: "arraybuffer"
        }).then(function(response) {
            // Convert array buffer to NetCDF object
            var netCDFData = response.data;

            // Extract lightning data from netCDF data and convert it into JSON format
            var lightningData = extractAndConvertToJSON(netCDFData);

            // Log the lightningData variable to the console
            console.log(lightningData);

            // Add lightning strikes to the map
            addLightningStrikes(lightningData);
        }).catch(function(error) {
            console.error('Error fetching lightning data:', error);
        });
    });
  </script>

  <!-- css to make a full screen map -->
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%; 
      width: 100%;
    }
  </style>

</head>
<body>

  <!-- the div to displays the map  -->
  <div id="viewDiv"></div>

</body>
</html>